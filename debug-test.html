<!DOCTYPE html>
<html>
<head>
    <title>SSTV Debug Test</title>
</head>
<body>
    <h1>SSTV Encode/Decode Debug Test</h1>
    <button onclick="runTest()">Run Test</button>
    <pre id="log"></pre>
    <canvas id="testCanvas" width="320" height="240"></canvas>
    <canvas id="resultCanvas" width="320" height="240"></canvas>

    <script type="module">
        import { SSTVDecoder } from './src/utils/SSTVDecoder.js';
        import { SSTVEncoder } from './src/utils/SSTVEncoder.js';

        function log(msg) {
            document.getElementById('log').textContent += `${msg}\n`;
            console.log(msg);
        }

        window.runTest = async () => {
            document.getElementById('log').textContent = '';
            log('Starting test...');

            // Create a simple test image
            const canvas = document.getElementById('testCanvas');
            const ctx = canvas.getContext('2d');

            // Left half black, right half white
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, 160, 240);
            ctx.fillStyle = 'white';
            ctx.fillRect(160, 0, 160, 240);
            log('Created test pattern: left=black, right=white');

            // Convert to blob
            const imageBlob = await new Promise(resolve => canvas.toBlob(resolve));
            log(`Image blob size: ${imageBlob.size} bytes`);

            // Encode
            const encoder = new SSTVEncoder('ROBOT36');
            const imageFile = new File([imageBlob], 'test.png', { type: 'image/png' });
            const audioBlob = await encoder.encodeImage(imageFile);
            log(`Audio blob size: ${audioBlob.size} bytes`);
            log(`Expected audio duration: ~36 seconds for Robot 36`);

            // Decode
            const decoder = new SSTVDecoder();
            const audioFile = new File([audioBlob], 'test.wav', { type: 'audio/wav' });
            const decodedDataUrl = await decoder.decodeAudio(audioFile);
            log(`Decoded data URL length: ${decodedDataUrl.length}`);

            // Display decoded image
            const img = new Image();
            img.onload = () => {
                const resultCanvas = document.getElementById('resultCanvas');
                const resultCtx = resultCanvas.getContext('2d');
                resultCtx.drawImage(img, 0, 0);

                // Sample some pixels to verify
                const imageData = resultCtx.getImageData(0, 0, 320, 240);
                const leftPixel = imageData.data[0]; // Should be black (0)
                const rightPixel = imageData.data[(160 * 4)]; // Should be white (255)

                log(`\nPixel sampling:`);
                log(`Left side (0,0): R=${imageData.data[0]}, G=${imageData.data[1]}, B=${imageData.data[2]}`);
                log(`Right side (160,0): R=${imageData.data[160*4]}, G=${imageData.data[160*4+1]}, B=${imageData.data[160*4+2]}`);

                if (leftPixel < 50 && rightPixel > 200) {
                    log('\n✅ TEST PASSED: Decode recovered the pattern!');
                } else {
                    log('\n❌ TEST FAILED: Decoded image does not match');
                }
            };
            img.src = decodedDataUrl;
        };
    </script>
</body>
</html>
